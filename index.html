<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basit Chat</title>
  <style>
    :root {
      --primary-bg: #0b0f17;
      --secondary-bg: rgba(255, 255, 255, .03);
      --message-bg: rgba(255, 255, 255, .04);
      --my-message-bg: rgba(120, 160, 255, .12);
      --text-color: #e7eefc;
      --border-color: rgba(255, 255, 255, .12);
      --border-light: rgba(255, 255, 255, .10);
      --input-bg: rgba(255, 255, 255, .06);
      --form-bg: rgba(0, 0, 0, .15);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 999px;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      margin: 0; 
      background: var(--primary-bg); 
      color: var(--text-color);
      min-height: 100vh;
    }
    
    .wrap { 
      max-width: 900px; 
      margin: 0 auto; 
      padding: 12px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .top { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 10px; 
      flex-wrap: wrap;
      padding: 8px 0;
    }
    
    .top h2 {
      margin: 0;
      font-size: 1.3rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .auth-section {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    
    button {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: var(--input-bg);
      color: var(--text-color);
      cursor: pointer;
      padding: 10px 14px;
      font-size: 0.9rem;
      white-space: nowrap;
      transition: all 0.2s ease;
    }
    
    button:hover:not(:disabled) {
      background: rgba(255, 255, 255, .09);
    }
    
    button:disabled { 
      opacity: .5; 
      cursor: not-allowed; 
    }
    
    .pill { 
      padding: 6px 10px; 
      border: 1px solid var(--border-light); 
      border-radius: var(--radius-full); 
      font-size: 0.8rem; 
      opacity: .9; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }
    
    .chat { 
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-top: 12px; 
      border: 1px solid var(--border-color); 
      border-radius: var(--radius-lg); 
      overflow: hidden; 
      background: var(--secondary-bg);
      min-height: 0; /* Firefox iÃ§in flex item'Ä±n overflow Ã§alÄ±ÅŸmasÄ± iÃ§in */
    }
    
    .msgs { 
      flex: 1;
      overflow: auto; 
      padding: 12px; 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
      -webkit-overflow-scrolling: touch; /* Mobilde smooth scroll */
    }
    
    .msg { 
      max-width: 85%; 
      padding: 10px 12px; 
      border-radius: var(--radius-md); 
      border: 1px solid var(--border-light); 
      background: var(--message-bg);
      word-wrap: break-word;
      overflow-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0.7; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .me { 
      align-self: flex-end; 
      background: var(--my-message-bg);
      border-color: rgba(120, 160, 255, .2);
    }
    
    .meta { 
      font-size: 0.8rem; 
      opacity: .7; 
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .time {
      font-size: 0.7rem;
      opacity: 0.6;
    }
    
    .msg-content {
      line-height: 1.4;
    }
    
    form { 
      display: flex; 
      gap: 10px; 
      padding: 12px; 
      border-top: 1px solid var(--border-light); 
      background: var(--form-bg);
      flex-shrink: 0;
    }
    
    input { 
      flex: 1; 
      padding: 12px; 
      outline: none; 
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 1rem;
      min-width: 0; /* Flex item'Ä±n kÃ¼Ã§Ã¼lmesi iÃ§in */
    }
    
    input::placeholder {
      color: rgba(231, 238, 252, 0.6);
    }
    
    /* Mobil cihazlar iÃ§in responsive stiller */
    @media (max-width: 768px) {
      .wrap {
        padding: 8px;
        height: 100vh;
      }
      
      .top {
        padding: 4px 0;
      }
      
      .top h2 {
        font-size: 1.1rem;
        max-width: 60%;
      }
      
      .auth-section {
        gap: 6px;
      }
      
      button {
        padding: 8px 12px;
        font-size: 0.85rem;
      }
      
      .pill {
        font-size: 0.75rem;
        padding: 5px 8px;
        max-width: 120px;
      }
      
      .msgs {
        padding: 10px;
      }
      
      .msg {
        max-width: 90%;
        padding: 8px 10px;
      }
      
      .meta {
        font-size: 0.75rem;
      }
      
      .msg-content {
        font-size: 0.95rem;
      }
      
      form {
        padding: 10px;
        gap: 8px;
      }
      
      input {
        padding: 10px;
        font-size: 0.95rem;
      }
    }
    
    @media (max-width: 480px) {
      .wrap {
        padding: 6px;
      }
      
      .top {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .top h2 {
        max-width: 100%;
        font-size: 1rem;
      }
      
      .auth-section {
        width: 100%;
        justify-content: space-between;
      }
      
      .pill {
        max-width: 150px;
      }
      
      .chat {
        margin-top: 8px;
        border-radius: var(--radius-md);
      }
      
      .msg {
        max-width: 95%;
      }
      
      .msgs {
        padding: 8px;
        gap: 8px;
      }
      
      form {
        flex-direction: column;
        gap: 8px;
      }
      
      input, button {
        width: 100%;
      }
      
      #send {
        padding: 10px;
      }
    }
    
    /* Ã‡ok kÃ¼Ã§Ã¼k ekranlar iÃ§in */
    @media (max-width: 360px) {
      .top h2 {
        font-size: 0.9rem;
      }
      
      button {
        font-size: 0.8rem;
        padding: 7px 10px;
      }
      
      .pill {
        font-size: 0.7rem;
        max-width: 100px;
      }
      
      .msg {
        padding: 7px 9px;
      }
      
      .meta {
        font-size: 0.7rem;
      }
      
      .msg-content {
        font-size: 0.9rem;
      }
    }
    
    /* Koyu tema iÃ§in ek renkler */
    @media (prefers-color-scheme: dark) {
      :root {
        --primary-bg: #0a0e15;
        --secondary-bg: rgba(255, 255, 255, .02);
        --message-bg: rgba(255, 255, 255, .03);
        --my-message-bg: rgba(100, 140, 255, .15);
      }
    }
    
    /* YÃ¼ksek kontrast modu desteÄŸi */
    @media (prefers-contrast: high) {
      :root {
        --border-color: rgba(255, 255, 255, .3);
        --border-light: rgba(255, 255, 255, .25);
      }
    }
    
    /* iOS input stil dÃ¼zeltmesi */
    input[type="text"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    
    /* Mesajlarda gÃ¶rsel medya iÃ§in */
    .msg img, .msg video {
      max-width: 100%;
      border-radius: var(--radius-sm);
      margin-top: 5px;
    }
    
    /* Scrollbar stilleri */
    .msgs::-webkit-scrollbar {
      width: 6px;
    }
    
    .msgs::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }
    
    .msgs::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 3px;
    }
    
    .msgs::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    
    /* Firefox iÃ§in scrollbar */
    .msgs {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.15) rgba(255, 255, 255, 0.05);
    }
    
    /* Online kullanÄ±cÄ± sayÄ±sÄ± gÃ¶sterimi */
    .online-count {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      opacity: 0.7;
      margin-left: 8px;
    }
    
    .online-dot {
      width: 8px;
      height: 8px;
      background-color: #4CAF50;
      border-radius: 50%;
      display: inline-block;
    }
    
    /* Mesaj gÃ¶nderildiÄŸinde feedback */
    .sending {
      opacity: 0.7;
    }
    
    /* BoÅŸ mesaj listesi durumu */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(231, 238, 252, 0.5);
      text-align: center;
      padding: 20px;
    }
    
    .empty-state p {
      margin: 10px 0 0 0;
      font-size: 0.9rem;
    }
    
    /* Klavye aÃ§Ä±kken mobilde daha iyi deneyim */
    @media (max-height: 500px) {
      .wrap {
        height: auto;
        min-height: 100vh;
      }
      
      .msgs {
        max-height: 60vh;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h2>Basit Chat (Firestore)</h2>
      <div class="auth-section">
        <button id="login" type="button">Google ile giriÅŸ</button>
        <button id="logout" type="button" style="display:none;">Ã‡Ä±kÄ±ÅŸ</button>
        <div class="pill" id="status">GiriÅŸ bekleniyorâ€¦</div>
      </div>
    </div>

    <div class="chat">
      <div class="msgs" id="msgs">
        <div class="empty-state" id="emptyState">
          <div>ðŸ’¬</div>
          <p>HenÃ¼z mesaj yok. Ä°lk mesajÄ± sen gÃ¶nder!</p>
        </div>
      </div>
      <form id="form">
        <input id="text" maxlength="1000" placeholder="Mesaj yazâ€¦" autocomplete="off" />
        <button id="send" disabled>GÃ¶nder</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDN0zwDiK0MveXRkykgkhG-p-oqBvanF7U",
      authDomain: "websitelerico.firebaseapp.com",
      projectId: "websitelerico",
      storageBucket: "websitelerico.firebasestorage.app",
      messagingSenderId: "848484251740",
      appId: "1:848484251740:web:a7692eeef83ca05e3b4e99",
      measurementId: "G-9V22FDX9N0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const roomId = "public";
    const msgsEl = document.getElementById("msgs");
    const emptyStateEl = document.getElementById("emptyState");
    const statusEl = document.getElementById("status");
    const form = document.getElementById("form");
    const textEl = document.getElementById("text");
    const sendBtn = document.getElementById("send");
    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");

    let uid = null;
    let unsubscribe = null;
    let lastMessageTime = null;

    const esc = (s) =>
      (s || "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));

    function scrollBottom() { 
      setTimeout(() => {
        msgsEl.scrollTop = msgsEl.scrollHeight;
      }, 100);
    }

    function formatTime(timestamp) {
      if (!timestamp) return '';
      
      let date;
      if (timestamp.toDate) {
        date = timestamp.toDate();
      } else if (timestamp instanceof Date) {
        date = timestamp;
      } else {
        return '';
      }
      
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      
      if (diffMins < 1) {
        return 'ÅŸimdi';
      } else if (diffMins < 60) {
        return `${diffMins} dk`;
      } else if (diffHours < 24) {
        return `${diffHours} sa`;
      } else {
        return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
      }
    }

    function render(d) {
      const mine = d.uid === uid;
      const el = document.createElement("div");
      el.className = "msg" + (mine ? " me" : "");
      
      const messageTime = d.createdAt ? formatTime(d.createdAt) : '';
      const displayName = mine ? "sen" : esc(d.name || d.uid?.slice(0,6) || "user");
      
      el.innerHTML = `
        <div class="meta">
          <span>${displayName}</span>
          ${messageTime ? `<span class="time">${messageTime}</span>` : ''}
        </div>
        <div class="msg-content">${esc(d.text)}</div>
      `;
      
      msgsEl.appendChild(el);
      
      // BoÅŸ durum mesajÄ±nÄ± gizle
      if (emptyStateEl) {
        emptyStateEl.style.display = 'none';
      }
    }

    loginBtn.addEventListener("click", async () => {
      try {
        loginBtn.disabled = true;
        loginBtn.textContent = "GiriÅŸ yapÄ±lÄ±yor...";
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Google giriÅŸ hata";
        alert(e.code === 'auth/popup-closed-by-user' ? 'GiriÅŸ penceresi kapatÄ±ldÄ±' : 'GiriÅŸ hatasÄ±: ' + (e.code || e.message));
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = "Google ile giriÅŸ";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (unsubscribe) { unsubscribe(); unsubscribe = null; }

      if (!user) {
        uid = null;
        statusEl.textContent = "GiriÅŸ bekleniyorâ€¦";
        sendBtn.disabled = true;
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        msgsEl.innerHTML = '';
        
        // BoÅŸ durum mesajÄ±nÄ± gÃ¶ster
        if (emptyStateEl) {
          emptyStateEl.style.display = 'flex';
        }
        
        return;
      }

      uid = user.uid;
      const displayName = user.displayName || user.email || "KullanÄ±cÄ±";
      statusEl.textContent = displayName.length > 15 ? displayName.substring(0, 15) + '...' : displayName;
      statusEl.title = displayName; // Tam adÄ± tooltip olarak gÃ¶ster
      sendBtn.disabled = false;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";

      const messagesRef = collection(db, "rooms", roomId, "messages");
      const q = query(messagesRef, orderBy("createdAt", "asc"), limit(300));

      unsubscribe = onSnapshot(q, (snap) => {
        msgsEl.innerHTML = "";
        
        if (snap.empty && emptyStateEl) {
          emptyStateEl.style.display = 'flex';
        } else {
          if (emptyStateEl) emptyStateEl.style.display = 'none';
          
          snap.forEach(doc => {
            const data = doc.data();
            render(data);
            
            // Son mesaj zamanÄ±nÄ± kaydet
            if (data.createdAt) {
              lastMessageTime = data.createdAt;
            }
          });
          
          scrollBottom();
        }
      }, (e) => {
        console.error(e);
        statusEl.textContent = "BaÄŸlantÄ± hatasÄ±";
      });
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = textEl.value.trim();
      if (!text || !uid) return;

      sendBtn.disabled = true;
      sendBtn.textContent = "GÃ¶nderiliyor...";
      
      try {
        const messagesRef = collection(db, "rooms", roomId, "messages");
        await addDoc(messagesRef, {
          text,
          uid,
          name: auth.currentUser?.displayName || auth.currentUser?.email || "user",
          createdAt: serverTimestamp()
        });
        textEl.value = "";
      } catch (err) {
        console.error(err);
        alert("Mesaj gÃ¶nderilemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "GÃ¶nder";
        textEl.focus();
        
        // Mobil klavye iÃ§in tekrar odaklan
        if (window.innerWidth < 768) {
          setTimeout(() => {
            textEl.focus();
          }, 100);
        }
      }
    });

    // Enter tuÅŸu ile gÃ¶nder, Shift+Enter ile yeni satÄ±r
    textEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (!sendBtn.disabled) {
          form.dispatchEvent(new Event("submit"));
        }
      }
    });

    // Sayfa yÃ¼klendiÄŸinde input'a odaklan
    window.addEventListener("load", () => {
      // KÄ±sa bir gecikme ile odaklan
      setTimeout(() => {
        textEl.focus();
      }, 500);
    });

    // Klavye aÃ§Ä±kken mesaj alanÄ±nÄ± ayarla (mobil iÃ§in)
    let initialViewportHeight = window.innerHeight;
    
    window.addEventListener("resize", () => {
      // Bu mobil klavye aÃ§Ä±ldÄ±ÄŸÄ±nda viewport deÄŸiÅŸimini tespit etmek iÃ§in
      if (window.innerHeight < initialViewportHeight * 0.7) {
        // Klavye aÃ§Ä±ldÄ±, son mesaja kaydÄ±r
        scrollBottom();
      }
    });
    
    // Ã‡evrimdÄ±ÅŸÄ± durumda uyarÄ±
    window.addEventListener("online", () => {
      statusEl.style.color = ""; // VarsayÄ±lan renge dÃ¶n
    });
    
    window.addEventListener("offline", () => {
      const originalText = statusEl.textContent;
      statusEl.textContent = "Ã‡evrimdÄ±ÅŸÄ±";
      statusEl.style.color = "#ff6b6b";
      
      // Ã‡evrimiÃ§i olunca eski metne dÃ¶n
      window.addEventListener("online", () => {
        statusEl.textContent = originalText;
        statusEl.style.color = "";
      }, { once: true });
    });
  </script>
</body>
</html>
