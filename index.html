<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat + Mahsuplaşma</title>
  <style>
    :root {
      --primary-bg: #0b0f17;
      --secondary-bg: rgba(255, 255, 255, .03);
      --message-bg: rgba(255, 255, 255, .04);
      --my-message-bg: rgba(120, 160, 255, .12);
      --text-color: #e7eefc;
      --border-color: rgba(255, 255, 255, .12);
      --border-light: rgba(255, 255, 255, .10);
      --input-bg: rgba(255, 255, 255, .06);
      --form-bg: rgba(0, 0, 0, .15);
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 999px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      background: var(--primary-bg);
      color: var(--text-color);
      min-height: 100vh;
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 12px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 8px 0;
    }
    .top h2 { margin: 0; font-size: 1.2rem; }
    .auth-section {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    button {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: var(--input-bg);
      color: var(--text-color);
      cursor: pointer;
      padding: 10px 14px;
      font-size: 0.9rem;
      white-space: nowrap;
      transition: all 0.2s ease;
    }
    button:hover:not(:disabled) { background: rgba(255,255,255,.09); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .pill {
      padding: 6px 10px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      opacity: .9;
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* CHAT */
    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-top: 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--secondary-bg);
      min-height: 0;
    }
    .msgs {
      flex: 1;
      overflow: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg {
      max-width: 85%;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: var(--message-bg);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .me { align-self: flex-end; background: var(--my-message-bg); border-color: rgba(120, 160, 255, .2); }
    .meta {
      font-size: 0.8rem;
      opacity: .7;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .time { font-size: 0.75rem; opacity: 0.65; }
    .msg-content { line-height: 1.35; }

    form.chatbar {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid var(--border-light);
      background: var(--form-bg);
      flex-shrink: 0;
    }
    input, select, textarea {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: var(--input-bg);
      color: var(--text-color);
      padding: 12px;
      outline: none;
      font-size: 1rem;
    }
    input { flex: 1; min-width: 0; }
    input::placeholder, textarea::placeholder { color: rgba(231,238,252,0.6); }

    /* SETTLEMENT */
    .panel {
      margin-top: 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--secondary-bg);
    }
    .panel-header {
      padding: 12px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .panel-body { padding: 12px; display: grid; gap: 10px; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .label { font-size: 0.85rem; opacity: .8; margin-bottom: 6px; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    textarea { min-height: 90px; resize: vertical; }

    .hint { opacity: .75; font-size: 0.85rem; line-height: 1.35; }

    .list {
      margin-top: 12px;
      border-top: 1px solid var(--border-light);
      padding-top: 12px;
      display: grid;
      gap: 10px;
    }
    .card {
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 12px;
      background: rgba(255,255,255,.03);
    }
    .card-title { display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .card-title strong { font-size: 1rem; }
    .badge {
      font-size: 0.75rem;
      opacity: .8;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-full);
      padding: 4px 8px;
    }

    @media (max-width: 720px) {
      .grid2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h2 id="pageTitle">Chat</h2>

      <div class="auth-section">
        <button id="openSettlement" type="button" style="display:none;">Mahsuplaşma (Yeni Sekme)</button>
        <button id="openChat" type="button" style="display:none;">Chat (Yeni Sekme)</button>

        <button id="login" type="button">Google ile giriş</button>
        <button id="logout" type="button" style="display:none;">Çıkış</button>
        <div class="pill" id="status">Giriş bekleniyor…</div>
      </div>
    </div>

    <!-- CHAT VIEW -->
    <div class="chat" id="chatView" style="display:none;">
      <div class="msgs" id="msgs"></div>
      <form class="chatbar" id="chatForm">
        <input id="chatText" maxlength="1000" placeholder="Mesaj yaz…" autocomplete="off" />
        <button id="sendChat" disabled>Gönder</button>
      </form>
    </div>

    <!-- SETTLEMENT VIEW -->
    <div class="panel" id="settlementView" style="display:none;">
      <div class="panel-header">
        <div>
          <div style="font-size:1.05rem; font-weight:700;">Mahsuplaşma</div>
          <div class="hint">Fiyat / kullanım / katılımcılar tanımla. Chat ayrı sekmede açık kalabilir.</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="backToChatLocal" type="button">Chat’e dön</button>
        </div>
      </div>

      <div class="panel-body">
        <div class="grid2">
          <div class="field">
            <div class="label">Başlık</div>
            <input id="stTitle" placeholder="Örn: Akşam Yemeği" maxlength="80" />
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label">Toplam Fiyat</div>
              <input id="stPrice" type="number" inputmode="decimal" placeholder="Örn: 1250" />
            </div>
            <div class="field">
              <div class="label">Para Birimi</div>
              <select id="stCurrency">
                <option value="TRY">TRY</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">Kullanım / Not</div>
          <textarea id="stNote" placeholder="Örn: 4 kişi, kişi başı paylaşılacak. Kim ne ödedi vs."></textarea>
        </div>

        <div class="grid2">
          <div class="field">
            <div class="label">Katılımcılar (çoklu seç)</div>
            <select id="stParticipants" multiple size="6"></select>
            <div class="hint">Listede kullanıcı görünmesi için en az 1 kez Google ile giriş yapmış olmalı.</div>
          </div>

          <div class="field">
            <div class="label">Hızlı ekleme</div>
            <input id="stManualName" placeholder="Listede yoksa isim yaz (opsiyonel)" maxlength="60" />
            <button id="addManualParticipant" type="button">Bu ismi katılımcılara ekle</button>
            <div class="hint">Bu “gerçek kullanıcı” değildir. Sadece kayıt için isim listesine ekler.</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="saveSettlement" type="button" disabled>Kaydet</button>
          <div class="pill" id="stStatus">Hazır</div>
        </div>

        <div class="list" id="settlementList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, getDoc,
      query, orderBy, limit, onSnapshot, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ✅ Kendi console config'in
    const firebaseConfig = {
      apiKey: "AIzaSyDN0zwDiK0MveXRkykgkhG-p-oqBvanF7U",
      authDomain: "websitelerico.firebaseapp.com",
      projectId: "websitelerico",
      storageBucket: "websitelerico.firebasestorage.app",
      messagingSenderId: "848484251740",
      appId: "1:848484251740:web:a7692eeef83ca05e3b4e99",
      measurementId: "G-9V22FDX9N0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ----- View mode (same file, different tab)
    const params = new URLSearchParams(location.search);
    const view = params.get("view") || "chat"; // chat | settlement

    const pageTitle = document.getElementById("pageTitle");
    const chatView = document.getElementById("chatView");
    const settlementView = document.getElementById("settlementView");

    const openSettlementBtn = document.getElementById("openSettlement");
    const openChatBtn = document.getElementById("openChat");
    const backToChatLocal = document.getElementById("backToChatLocal");

    function currentBaseUrl() {
      // aynı path üzerinde view değiştiriyoruz
      return location.origin + location.pathname;
    }
    function openInNewTab(targetView) {
      const url = currentBaseUrl() + "?view=" + encodeURIComponent(targetView);
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // UI switch
    if (view === "settlement") {
      pageTitle.textContent = "Mahsuplaşma";
      settlementView.style.display = "block";
      chatView.style.display = "none";
      openChatBtn.style.display = "inline-block";
      openSettlementBtn.style.display = "none";
    } else {
      pageTitle.textContent = "Chat";
      chatView.style.display = "flex";
      settlementView.style.display = "none";
      openSettlementBtn.style.display = "inline-block";
      openChatBtn.style.display = "none";
    }

    openSettlementBtn.addEventListener("click", () => openInNewTab("settlement"));
    openChatBtn.addEventListener("click", () => openInNewTab("chat"));
    backToChatLocal.addEventListener("click", () => {
      // aynı sekmede chat'e dön
      location.href = currentBaseUrl() + "?view=chat";
    });

    // ----- Auth
    const statusEl = document.getElementById("status");
    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");

    loginBtn.addEventListener("click", async () => {
      try {
        loginBtn.disabled = true;
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        alert(e.code || e.message);
      } finally {
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    const esc = (s) => (s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));

    function formatTime(ts) {
      if (!ts?.toDate) return "";
      const d = ts.toDate();
      return d.toLocaleString("tr-TR", { hour: "2-digit", minute:"2-digit" });
    }

    // ----- USERS: write current user to users/{uid} for dropdown later
    async function upsertUser(user) {
      if (!user) return;
      const userRef = doc(db, "users", user.uid);
      await setDoc(userRef, {
        uid: user.uid,
        displayName: user.displayName || "",
        email: user.email || "",
        photoURL: user.photoURL || "",
        lastSeenAt: serverTimestamp()
      }, { merge: true });
    }

    // ----- CHAT
    const msgsEl = document.getElementById("msgs");
    const chatForm = document.getElementById("chatForm");
    const chatText = document.getElementById("chatText");
    const sendChat = document.getElementById("sendChat");

    let uid = null;
    let unsubChat = null;

    function renderMsg(d) {
      const mine = d.uid === uid;
      const el = document.createElement("div");
      el.className = "msg" + (mine ? " me" : "");
      el.innerHTML = `
        <div class="meta">
          <span>${mine ? "sen" : esc(d.name || d.uid?.slice(0,6) || "user")}</span>
          <span class="time">${d.createdAt ? esc(formatTime(d.createdAt)) : ""}</span>
        </div>
        <div class="msg-content">${esc(d.text)}</div>
      `;
      msgsEl.appendChild(el);
    }

    function scrollBottom() {
      setTimeout(() => { msgsEl.scrollTop = msgsEl.scrollHeight; }, 60);
    }

    chatForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = chatText.value.trim();
      if (!text || !uid) return;

      sendChat.disabled = true;
      try {
        const messagesRef = collection(db, "rooms", "public", "messages");
        await addDoc(messagesRef, {
          text,
          uid,
          name: auth.currentUser?.displayName || auth.currentUser?.email || "user",
          createdAt: serverTimestamp()
        });
        chatText.value = "";
      } catch (err) {
        console.error(err);
        alert("Mesaj gönderilemedi. Rules/izin?");
      } finally {
        sendChat.disabled = false;
        chatText.focus();
      }
    });

    // ----- SETTLEMENT
    const stTitle = document.getElementById("stTitle");
    const stPrice = document.getElementById("stPrice");
    const stCurrency = document.getElementById("stCurrency");
    const stNote = document.getElementById("stNote");
    const stParticipants = document.getElementById("stParticipants");
    const stManualName = document.getElementById("stManualName");
    const addManualParticipantBtn = document.getElementById("addManualParticipant");
    const saveSettlementBtn = document.getElementById("saveSettlement");
    const stStatus = document.getElementById("stStatus");
    const settlementList = document.getElementById("settlementList");

    let unsubSettlements = null;
    let usersCache = []; // {uid, displayName, email}

    function optionLabel(u) {
      const name = u.displayName?.trim() || "";
      const email = u.email?.trim() || "";
      if (name && email) return `${name} (${email})`;
      return name || email || u.uid;
    }

    async function loadUsersForDropdown() {
      // basit: users koleksiyonundan son N kullanıcı
      // (İstersen ileride orderBy(lastSeenAt) + limit ile optimize edilir)
      const usersRef = collection(db, "users");
      const snap = await getDocs(usersRef);
      usersCache = [];
      snap.forEach(d => usersCache.push(d.data()));

      // dropdown doldur
      if (!stParticipants) return;
      stParticipants.innerHTML = "";
      // deterministik sıralama
      usersCache
        .sort((a,b) => optionLabel(a).localeCompare(optionLabel(b), "tr"))
        .forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.uid;
          opt.textContent = optionLabel(u);
          stParticipants.appendChild(opt);
        });
    }

    function getSelectedParticipantUids() {
      if (!stParticipants) return [];
      return Array.from(stParticipants.selectedOptions).map(o => o.value);
    }

    // Manual participant: gerçek user değil, adı string olarak kayda ekliyoruz
    // DB formatı: participants = [{type:"user", uid:"..."}, {type:"manual", name:"..."}]
    // dropdown seçilenler user uid, manual eklenenler string listede tutulur
    let manualParticipants = [];

    addManualParticipantBtn?.addEventListener("click", () => {
      const name = (stManualName.value || "").trim();
      if (!name) return;
      manualParticipants.push(name);
      stManualName.value = "";
      stStatus.textContent = `Manuel eklendi: ${name}`;
      setTimeout(() => stStatus.textContent = "Hazır", 1500);
    });

    saveSettlementBtn?.addEventListener("click", async () => {
      if (!uid) return;

      const title = (stTitle.value || "").trim() || "Mahsuplaşma";
      const priceNum = Number(stPrice.value);
      const currency = stCurrency.value || "TRY";
      const note = (stNote.value || "").trim();

      if (!Number.isFinite(priceNum) || priceNum <= 0) {
        alert("Toplam fiyat > 0 olmalı.");
        return;
      }

      const selectedUids = getSelectedParticipantUids();

      if (selectedUids.length === 0 && manualParticipants.length === 0) {
        alert("En az 1 katılımcı seç (veya manuel ekle).");
        return;
      }

      const participants = [
        ...selectedUids.map(u => ({ type: "user", uid: u })),
        ...manualParticipants.map(n => ({ type: "manual", name: n }))
      ];

      saveSettlementBtn.disabled = true;
      stStatus.textContent = "Kaydediliyor…";

      try {
        await addDoc(collection(db, "settlements"), {
          title,
          totalPrice: priceNum,
          currency,
          note,
          participants,
          createdByUid: uid,
          createdByName: auth.currentUser?.displayName || auth.currentUser?.email || "user",
          createdAt: serverTimestamp()
        });

        // reset form
        stTitle.value = "";
        stPrice.value = "";
        stNote.value = "";
        manualParticipants = [];
        Array.from(stParticipants.options).forEach(o => o.selected = false);

        stStatus.textContent = "Kaydedildi ✅";
        setTimeout(() => stStatus.textContent = "Hazır", 1500);
      } catch (e) {
        console.error(e);
        alert("Kaydedilemedi (rules/izin?)");
        stStatus.textContent = "Hata";
      } finally {
        saveSettlementBtn.disabled = false;
      }
    });

    function renderSettlementCard(d) {
      const created = d.createdAt ? formatTime(d.createdAt) : "";
      const p = d.participants || [];
      const userCount = p.filter(x => x.type === "user").length;
      const manualCount = p.filter(x => x.type === "manual").length;

      // katılımcı isimlerini çöz
      const names = p.map(x => {
        if (x.type === "manual") return x.name;
        const u = usersCache.find(uu => uu.uid === x.uid);
        return u ? (u.displayName || u.email || u.uid.slice(0,6)) : (x.uid?.slice(0,6) || "user");
      });

      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="card-title">
          <strong>${esc(d.title || "Mahsuplaşma")}</strong>
          <span class="badge">${esc(String(d.totalPrice))} ${esc(d.currency || "TRY")}</span>
        </div>
        <div class="hint" style="margin-top:8px;">
          <div><b>Katılımcılar:</b> ${esc(names.join(", "))} ${created ? ` • <span style="opacity:.75">${esc(created)}</span>` : ""}</div>
          ${d.note ? `<div style="margin-top:6px;"><b>Not:</b> ${esc(d.note)}</div>` : ""}
          <div style="margin-top:6px; opacity:.8;"><b>Oluşturan:</b> ${esc(d.createdByName || d.createdByUid?.slice(0,6) || "")}</div>
        </div>
      `;
      settlementList.appendChild(el);
    }

    function startSettlementsListener() {
      if (unsubSettlements) { unsubSettlements(); unsubSettlements = null; }
      const q = query(collection(db, "settlements"), orderBy("createdAt", "desc"), limit(30));
      unsubSettlements = onSnapshot(q, (snap) => {
        settlementList.innerHTML = "";
        snap.forEach(docSnap => renderSettlementCard(docSnap.data()));
      });
    }

    // ----- Global auth state
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        uid = null;
        statusEl.textContent = "Giriş bekleniyor…";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";

        // chat disable
        sendChat && (sendChat.disabled = true);

        // settlement disable
        saveSettlementBtn && (saveSettlementBtn.disabled = true);
        stParticipants && (stParticipants.innerHTML = "");

        // listeners kapat
        if (unsubChat) { unsubChat(); unsubChat = null; }
        if (unsubSettlements) { unsubSettlements(); unsubSettlements = null; }

        return;
      }

      uid = user.uid;
      const displayName = user.displayName || user.email || "Bağlandı";
      statusEl.textContent = displayName.length > 18 ? displayName.slice(0,18) + "…" : displayName;
      statusEl.title = displayName;

      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";

      // ✅ kullanıcıyı users koleksiyonuna yaz
      await upsertUser(user);

      // view’e göre davran
      if (view === "chat") {
        sendChat.disabled = false;

        // chat listener
        if (unsubChat) { unsubChat(); unsubChat = null; }
        const q = query(collection(db, "rooms", "public", "messages"), orderBy("createdAt", "asc"), limit(300));
        unsubChat = onSnapshot(q, (snap) => {
          msgsEl.innerHTML = "";
          snap.forEach(docSnap => renderMsg(docSnap.data()));
          scrollBottom();
        }, (e) => {
          console.error(e);
          statusEl.textContent = "Chat bağlantı hatası";
        });
      }

      if (view === "settlement") {
        saveSettlementBtn.disabled = false;

        // dropdown users
        await loadUsersForDropdown();
        startSettlementsListener();
      }
    });
  </script>
</body>
</html>
